---
title: "snowdepth for stationdata only"
author: "Schimpfle, Wiech"
date: "2024-06-10"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



```{r}
# import libraies
library("stars")
library("ggplot2")
library("dplyr")
library("lubridate")

library("zoo")
library("colorspace")
library("mgcv")
library("raster")
```


```{r}
# set working directory
setwd("C:/Users/andre/OneDrive/Dokumente/UNI/Master_Semester_2/Geostatistics/FinalProject")
#setwd("/Users/sschimpfle/Atmosp√§renwissenschaften/Geostatistic/Final_Project/FinalProjectGeostatistic")
```

### Get political boundary data (GADM)

```{r}
# Processing GADM data
autBoundaries <- read_sf("gadm41_AUT_1.json")
plot(st_geometry(autBoundaries)) # plot view base R
ggplot() + geom_sf(data = autBoundaries, fill = "lightblue") # plot in "tidyverse"
```

```{r}
#To extract a state, e.g. Tirol, and:
tirol <- subset(autBoundaries, NAME_1 == "Tirol")
# plot tirol
plot(st_geometry(tirol)) # plot view base R
ggplot() + geom_sf(data = tirol, fill = "lightblue") # plot in "tidyverse"
```

### Get SRTM digital elevation model data (DEM)
```{r}
# Processing SRTM Data
# Listing all unzipped srtm_*.tif files
files <- list.files()
files <- files[grepl("srtm_.*.tif$", files)]
print(files)

tmp <- lapply(files, read_stars)

dem <- do.call(st_mosaic, tmp)
st_crs(dem) <- st_crs(4326) # Adding lonlat coordinate reference
plot(dem)
```

After we spent quite some time to download the data correctly and to create a file with which you can edit the Dyad task.

### Read in the data
```{r}
filename <- "snowdepthdata.rds"
df <-readRDS(filename)
head(df)
df$alt <- df$station_altitude
```
**Extract the names of all stations**
```{r}
# Extract the names of all stations
stations <- unique(df$station_name)
stations
```
**Add day of year yday to df**

```{r}
df$yday <- as.POSIXlt(df$date)$yday
```

```{r}
SnowModell <- gam(mean_snow_depth ~ s(alt, k = 5, bs = "cr"), data = df)
par(mfrow = c(1,2))
plot.gam(SnowModell)
```
```{r}
dem <- readRDS("dem.rds")
tirol <- readRDS("tirol.gadm.rds")
```

```{r}
plot(dem, col = gray.colors(51))
plot(tirol, col = gray.colors(51))
```

```{r}
dem <- crop(dem, extent(tirol))
sp <- SpatialPoints(coordinates(dem), proj4string = crs(tirol))
take <- which(!is.na(over(sp, tirol)))
values(dem)[!take] <- NA
newdata <- as.data.frame(coordinates(dem))
names(newdata) <- c("lon","lat")
newdata$alt <- values(dem)
newdata <- newdata[take, ]
```

```{r}
date <- as.POSIXlt("2019-12-01")
newdata$yday <- date$yday
Smodel <- predict(SnowModell, newdata = newdata)
```

```{r}
res <- dem
values(res) <- NA #initialize
res <- stack(res)
names(res) <- c("snowdepth")

# Then store the estimates (predictions)
values(res$snowdepth)[take] <- Smodel
```

```{r}
plot(res$snowdepth, col = diverge_hcl(51, h = c(260, 305),power = 1), main = sprintf("Daily mean temperature simple model %s", strftime(date, "%b %d")))
```

```{r}

tirol <- raster(tirol)
dem <- raster(dem$srtm_39_03.tif)
crs_tirol <- crs(tirol)
crs(dem) <- crs_tirol
dem <- raster(dem)
dem <- projectRaster(dem, crs = crs(tirol))
```
```{r}
extent(tirol)
extent(dem) <- extent(10, 15, 45, 50)
extent(dem)
```
```{r}
date <- as.POSIXlt("2019-12-01")
newdata$yday <- date$yday
Smodel <- predict(SnowModell, newdata = newdata)
```


